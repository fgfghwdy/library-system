<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>全功能超级图书管理系统</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="p-4">

<h3>添加新书</h3>
<input id="title" placeholder="书名" class="form-control w-25 mb-2">
<input id="author" placeholder="作者" class="form-control w-25 mb-2">
<button class="btn btn-success" onclick="addBook()">添加</button>
<hr>
<div class="search-bar">
    <input type="text" id="searchKeyword" placeholder="请输入书名或作者" />
    <button onclick="searchBooks()">搜索</button>
    <button onclick="loadBooks()">显示全部</button>
</div>

<!-- 用户选择 -->
<select id="userSelect" class="form-select w-25 mb-3">
    <option value="1">UserA</option>
    <option value="2">UserB</option>
</select>

<table class="table table-bordered" id="bookTable">
    <thead>
    <tr>
        <th>ID</th>
        <th>书名</th>
        <th>作者</th>
        <th>库存</th>
        <th>状态</th>
        <th>操作</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
    function loadBooks() {
        fetch('/books')
            .then(response => response.json())
            .then(data => {
                let html = '';
                data.forEach(book => {
                    html += `<tr>
                    <td>${book.id}</td>
                    <td>${book.title}</td>
                    <td>${book.author}</td>
                    <td>${book.stock}</td>
                    <td>${book.stock > 0 ? '在馆' : '已借出'}</td>
                    <td>
                        ${book.stock > 0
                        ? `<button class="btn btn-primary btn-sm" onclick="borrowBook(${book.id})">借书</button>`
                        : `<button class="btn btn-warning btn-sm" onclick="returnBook(${book.id})">还书</button>`
                    }
                    </td>
                </tr>`;
                });
                document.querySelector('#bookTable tbody').innerHTML = html;
            });
    }

    function borrowBook(bookId) {
        const userId = document.getElementById('userSelect').value;
        fetch(`/books/${bookId}/borrow/${userId}`, { method: 'POST' })
            .then(response => response.text())
            .then(data => {
                alert(data);
                loadBooks();
            })
            .catch(error => console.error('借书错误:', error));
    }

    function returnBook(bookId) {
        const userId = document.getElementById('userSelect').value;
        fetch(`/books/${bookId}/return/${userId}`, { method: 'POST' })
            .then(response => response.text())
            .then(data => {
                alert(data);
                loadBooks();
            })
            .catch(error => console.error('还书错误:', error));
    }
    function searchBooks() {
        const keyword = document.getElementById('searchKeyword').value.trim();
        const userId = document.getElementById('userSelect').value;

        if (!keyword) {
            alert("请输入搜索关键词");
            return;
        }

        fetch(`/books/search?keyword=${encodeURIComponent(keyword)}`)
            .then(response => response.json())
            .then(data => {
                let html = '';
                data.forEach(book => {
                    // ❗ 如果要保留借书/还书按钮，需要额外请求带 isBorrowedByCurrentUser 的接口
                    html += `<tr>
                    <td>${book.id}</td>
                    <td>${book.title}</td>
                    <td>${book.author}</td>
                    <td>${book.stock}</td>
                    <td>${book.stock > 0 ? '在馆' : '已借出'}</td>
                    <td>
                        ${book.stock > 0
                        ? `<button class="btn btn-primary btn-sm" onclick="borrowBook(${book.id})">借书</button>`
                        : `<button class="btn btn-warning btn-sm" onclick="returnBook(${book.id})">还书</button>`}
                    </td>
                </tr>`;
                });
                document.querySelector('#bookTable tbody').innerHTML = html;
            });
    }

    function loadBooks() {
        const userId = document.getElementById('userSelect').value;
        fetch(`/books/${userId}`)
            .then(response => response.json())
            .then(data => {
                let html = '';
                data.forEach(item => {
                    const book = item.book;
                    const isBorrowedByCurrentUser = item.borrowedByCurrentUser;

                    html += `<tr>
                    <td>${book.id}</td>
                    <td>${book.title}</td>
                    <td>${book.author}</td>
                    <td>${book.stock}</td>
                    <td>${book.stock > 0 ? '在馆' : '已借出'}</td>
                    <td>
                        ${isBorrowedByCurrentUser
                        ? `<button class="btn btn-warning btn-sm" onclick="returnBook(${book.id})">还书</button>`
                        : `<button class="btn btn-primary btn-sm" onclick="borrowBook(${book.id})">借书</button>`
                    }
                    </td>
                </tr>`;
                });
                document.querySelector('#bookTable tbody').innerHTML = html;
            });
    }

    // 页面加载时
    window.onload = loadBooks;
</script>

</body>
</html>
